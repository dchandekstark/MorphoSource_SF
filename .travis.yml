# Based on https://github.com/duke-libraries/rdr/blob/develop/.travis.yml

language: ruby
rvm:
  - 2.4.2
services:
  - postgresql
  # Use redis for background jobs
  - redis-server
addons:
  firefox: '61.0'
before_install:
  # from http://www.columbia.edu/~njn2118/journal/2016/10/28.html
  - wget https://github.com/mozilla/geckodriver/releases/download/v0.21.0/geckodriver-v0.21.0-linux64.tar.gz
  - mkdir geckodriver
  - tar -xzf geckodriver-v0.21.0-linux64.tar.gz -C geckodriver
  - export PATH=$PATH:$PWD/geckodriver
  # Download anc configure FITS
  # $TRAVIS_BUILD_DIR
  - mkdir tempdownload
  - cd tempdownload
  - curl http://projects.iq.harvard.edu/files/fits/files/fits-1.3.0.zip -o fits.zip
  - mkdir fits-1.3.0
  - unzip fits.zip -d fits-1.3.0
  - chmod a+x fits-1.3.0/*.sh
  - wget https://github.com/MorphoSource/morphosource-vagrant/blob/master/install_scripts/fits_config/fits.xml
  - wget https://github.com/MorphoSource/morphosource-vagrant/blob/master/install_scripts/fits_config/exiftool/exiftool_dicom_to_fits.xslt
  - wget https://github.com/MorphoSource/morphosource-vagrant/blob/master/install_scripts/fits_config/exiftool/exiftool_xslt_map.xml
  - cp fits.xml fits-1.3.0/xml/.
  - cp exiftool_dicom_to_fits.xslt fits-1.3.0/xml/exiftool/.
  - cp exiftool_xslt_map.xml fits-1.3.0/xml/exiftool/.
  - cd ..
  - export PATH=$PATH:$PWD/tempdownload/fits-1.3.0
  # echo "PATH=\${PATH}:$FITS_PATH" >> .bashrc
before_script:
  - "cp .rspec.travis .rspec"
  # Don't need to use role_map if using hydra-role-manager
  # - "cp config/role_map.yml.sample config/role_map.yml"
  - "cp spec/travis_spec_helper.rb spec/spec_helper.rb"
  # Sets up test db name to be travis_ci_test
  - "cp config/database.yml.travis config/database.yml"
  - "psql -c 'create database travis_ci_test;' -U postgres"

script: "bundle exec rake ci"
jdk:
  - oraclejdk8
